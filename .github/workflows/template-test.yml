# SPDX-FileCopyrightText: Â© 2025 open-nudge <https://github.com/open-nudge>
# SPDX-FileContributor: szymonmaszke <github@maszke.co>
#
# SPDX-License-Identifier: Apache-2.0

---
name: "Template Test"

on:
  pull_request:
    branches:
      - "main"
  merge_group:
    types:
      - "checks_requested"
  workflow_dispatch:

permissions: {} # yamllint disable-line rule:braces

jobs:
  template-test:
    timeout-minutes: 30
    name: "Template Test"
    permissions:
      contents: "read"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Harden Runner"
        # yamllint disable rule:line-length
        uses: "step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0" # v2.12.0
        # yamllint enable rule:line-length
        with:
          disable-sudo-and-containers: true
          egress-policy: "block"
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            nodejs.org:443
            objects.githubusercontent.com:443
            pdm-project.org:443
            pdm.fming.dev:443
            proxy.golang.org:443
            pypi.org:443
            raw.githubusercontent.com:443
            registry.npmjs.org:443
            storage.googleapis.com:443
            sum.golang.org:443
            endoflife.date:443
            api.osv.dev:443
            api.deps.dev:443
            endoflife.date:443
            semgrep.dev:443
            fonts.google.com:443
            fonts.gstatic.com:443
      - name: "Checkout repository"
        # yamllint disable rule:line-length
        uses: "actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683" # v4.2.2
        # yamllint enable rule:line-length
        with:
          persist-credentials: false
      - name: "Setup git credentials"
        # yamllint disable rule:line-length
        uses: "./.github/actions/git-setup"
        # yamllint enable rule:line-length
      - name: "Setup template"
        # yamllint disable rule:line-length
        uses: "./.github/actions/template-setup"
        # yamllint enable rule:line-length
        with:
          template-repository: "opentemplate"
          repository: "template_test"
          template-owner: "open-nudge"
          owner: "open-nudge"
          template-description: >-
            The simplest to use, yet the most comprehensive Python template
          description: "Test opentemplate setup"
      - name: "Setup git credentials"
        # yamllint disable rule:line-length
        uses: "./.github/actions/git-setup"
        # yamllint enable rule:line-length
      - name: "Create new branch"
        run: >
          git checkout -b template-test
      - name: "Check outdated PDM packages"
        run: >
          pdm outdated -v --include-sub
      - name: "Setup dev environment"
        run: >
          pdm setup

  pre-commit-test:
    name: "pre-commit"
    permissions:
      contents: "read"
      pull-requests: "write"
    # yamllint disable rule:line-length
    uses: "./.github/workflows/pre-commit-reusable.yml"
    # yamllint enable rule:line-length
...
