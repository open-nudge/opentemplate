# SPDX-FileCopyrightText: Â© 2025 open-nudge <https://github.com/open-nudge>
# SPDX-FileContributor: szymonmaszke <github@maszke.co>
#
# SPDX-License-Identifier: Apache-2.0

---
name: "Template Test"

on:
  pull_request:
    branches:
      - "main"
  merge_group:
    types:
      - "checks_requested"
  workflow_dispatch:

# enq: the only way to set permissions to none in GH Actions
permissions: {} # yamllint disable-line rule:braces

concurrency:
  group: >
    ${{ github.workflow_ref }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  template-test:
    timeout-minutes: 30
    name: "Template Test"
    permissions:
      contents: "read"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Harden Runner"
        # enq: hash with name and version always longer than 80 chars
        # yamllint disable rule:line-length
        uses: "step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76" # v2.14.0
        # yamllint enable rule:line-length
        with:
          disable-sudo-and-containers: true
          egress-policy: "block"
          allowed-endpoints: >
            api.github.com:443
            docs.github.com:443
            files.pythonhosted.org:443
            github.com:443
            grafana.com:443
            guides.github.com:443
            img.shields.io:443
            objects.githubusercontent.com:443
            opennudge.com:443
            opensource.org:443
            openssf.org:443
            pdm-project.org:443
            pdm.fming.dev:443
            peps.python.org:443
            pre-commit.com:443
            proxy.golang.org:443
            pypi.org:443
            raw.githubusercontent.com:443
            release-assets.githubusercontent.com:443
            scorecard.dev:443
            semver.org:443
            slsa.dev:443
            storage.googleapis.com:443
            sum.golang.org:443
            tag-security.cncf.io:443
            www.bestpractices.dev:443
            www.conventionalcommits.org:443
      - name: "Checkout repository"
        # enq: hash with name and version always longer than 80 chars
        # yamllint disable rule:line-length
        uses: "actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683" # v4.2.2
        # yamllint enable rule:line-length
        with:
          persist-credentials: false
      - name: "Setup git credentials"
        # enq: hash with name and version always longer than 80 chars
        # yamllint disable rule:line-length
        # enq: unpinned as it allows projects to use the latest
        uses: "open-nudge/opentemplate/.github/actions/git-setup@main" # zizmor: ignore[unpinned-uses]
        # yamllint enable rule:line-length
      - name: "Setup template"
        # enq: hash with name and version always longer than 80 chars
        # yamllint disable rule:line-length
        # enq: unpinned as it allows projects to use the latest
        uses: "open-nudge/opentemplate/.github/actions/template-setup@main" # zizmor: ignore[unpinned-uses]
        # yamllint enable rule:line-length
        with:
          template-repository: "opentemplate"
          repository: "template_test"
          template-owner: "open-nudge"
          owner: "open-nudge"
          template-description: >-
            All-in-one Python template. One click. Everything included.
          description: "Test opentemplate setup"
      - name: "Setup git credentials"
        # enq: hash with name and version always longer than 80 chars
        # yamllint disable rule:line-length
        # enq: unpinned as it allows projects to use the latest
        uses: "open-nudge/opentemplate/.github/actions/git-setup@main" # zizmor: ignore[unpinned-uses]
        # yamllint enable rule:line-length
      - name: "Create new branch"
        run: >
          git checkout -b template-test
      - name: "Check outdated PDM packages"
        run: >
          pdm outdated -v --include-sub
      - name: "Setup dev environment"
        run: >
          pdm setup

  pre-commit-test:
    name: "pre-commit"
    permissions:
      pull-requests: "write" # Needed to create pull request
      contents: "read"
    # enq: hash with name and version always longer than 80 chars
    # yamllint disable rule:line-length
    # enq: unpinned as it allows projects to use the latest
    uses: "open-nudge/opentemplate/.github/workflows/pre-commit-reusable.yml@main" # zizmor: ignore[unpinned-uses]
    # yamllint enable rule:line-length
...
